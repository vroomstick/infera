name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test-backend:
    runs-on: ubuntu-latest
    
    # PostgreSQL service container with pgvector
    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_USER: infera
          POSTGRES_PASSWORD: infera_test
          POSTGRES_DB: infera_test
        ports:
          - 5432:5432
        # Health check to wait for Postgres to be ready
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    defaults:
      run:
        working-directory: ./backend
    
    env:
      DATABASE_URL: postgresql://infera:infera_test@localhost:5432/infera_test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Free disk space
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: false
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true
    
    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'
        cache-dependency-path: 'backend/requirements.txt'
    
    - name: Cache HuggingFace models
      uses: actions/cache@v4
      with:
        path: ~/.cache/huggingface
        key: ${{ runner.os }}-huggingface-${{ hashFiles('backend/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-huggingface-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest ruff
    
    - name: Install PostgreSQL client
      run: |
        sudo apt-get update
        sudo apt-get install -y postgresql-client
    
    - name: Initialize database
      run: |
        # Enable pgvector extension and create schema
        PGPASSWORD=infera_test psql -h localhost -U infera -d infera_test -c "CREATE EXTENSION IF NOT EXISTS vector;"
        python -c "from data.database import init_db; init_db()"
    
    - name: Lint with ruff
      run: |
        ruff check . --ignore E501 --exit-zero
    
    - name: Run tests
      run: |
        python -m pytest tests/ -q --tb=short
    
    - name: Run evaluation (smoke test)
      run: |
        python -c "from evaluation.eval_scorer import load_labeled_data; data = load_labeled_data(); print(f'Loaded {len(data[\"samples\"])} samples')"

  docker-backend:
    runs-on: ubuntu-latest
    needs: test-backend
    
    steps:
    - name: Free disk space
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: false
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true
    
    - uses: actions/checkout@v4
    
    - name: Build Docker image
      run: |
        docker build -t infera:ci ./backend
    
    - name: Test Docker image
      run: |
        # Just verify the image builds and Python imports work
        # (actual DB tests run in test-backend job with service container)
        docker run --rm -e DATABASE_URL=postgresql://fake:fake@localhost/fake infera:ci python -c "print('Docker image built successfully')"

  # Integration tests (Phase 7 - v4.5)
  integration-tests:
    runs-on: ubuntu-latest
    needs: test-backend
    
    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_USER: infera
          POSTGRES_PASSWORD: infera_test
          POSTGRES_DB: infera_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    defaults:
      run:
        working-directory: ./backend
    
    env:
      DATABASE_URL: postgresql://infera:infera_test@localhost:5432/infera_test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Free disk space
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: false
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true
    
    - name: Cache HuggingFace models
      uses: actions/cache@v4
      with:
        path: ~/.cache/huggingface
        key: ${{ runner.os }}-huggingface-${{ hashFiles('backend/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-huggingface-
    
    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'
        cache-dependency-path: 'backend/requirements.txt'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest
    
    - name: Install PostgreSQL client
      run: |
        sudo apt-get update
        sudo apt-get install -y postgresql-client
    
    - name: Initialize database
      run: |
        PGPASSWORD=infera_test psql -h localhost -U infera -d infera_test -c "CREATE EXTENSION IF NOT EXISTS vector;"
        python -c "from data.database import init_db; init_db()"
    
    - name: Run integration tests
      run: |
        python -m pytest tests/test_integration.py -q --tb=short
